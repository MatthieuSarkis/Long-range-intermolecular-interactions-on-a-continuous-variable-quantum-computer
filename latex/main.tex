\documentclass[reprint, amsmath, amssymb, aps]{revtex4-2}

\usepackage{graphicx}
\graphicspath{{./assets/figures/}}
\usepackage{dcolumn}
\usepackage{bm}
\usepackage{diagbox}
\usepackage[table]{xcolor}
\usepackage{hyperref}
\usepackage{comment}
\newcolumntype{L}{>{$}l<{$}} % math-mode version of "l" column type
\usepackage{float} % To fix location of tables with H
\usepackage[ruled,vlined]{algorithm2e}
\usepackage{braket}
\usepackage{amsthm}
\usepackage{cleveref}

\newtheorem{definition}{Definition}
\newtheorem{prop}{Proposition}
\DeclareMathOperator{\tr}{Tr}

\begin{document}

\preprint{}

\title{Simulating Quantum Drude Oscillators on a photonic quantum computer}
%\thanks{}

\author{Matthieu Sarkis}
\email{matthieu.sarkis@uni.lu}

\affiliation{
Department of Physics and Materials Science\\ University of Luxembourg, L-1511, Luxembourg City, Luxembourg.
}

\author{Adel Sohbi}
\email{sohbi@kias.re.kr}

\affiliation{
ORCA
}

%\collaboration{}%\noaffiliation

\date{\today}

\begin{abstract}
%\begin{description}
%\item[Usage]
%Secondary publications and information retrieval purposes.
%\item[Structure]
%You may use the \texttt{description} environment to structure your abstract;
%use the optional argument of the \verb+\item+ command to give the category of each item.
%\end{description}
\end{abstract}

%\keywords{Suggested keywords}%Use showkeys class option if keyword
                              %display desired
\maketitle

%\tableofcontents

\section{Remarks and questions}

\textcolor{cyan}{
    Remarks and questions that should be addressed:
    \begin{itemize}
        \item Are alg. (\ref{alg:energy_computation}) or (\ref{alg:energy_computation_quadratures}) the best since one needs to prepare the state twice to measure both the position quadratures and the photon numbers. Maybe a single measure in the coherent states basis would be possible? This can be achieved by a heterodyne measurement. With strawbery fields it can only be performed in the Gaussian or Bosonic backends, but not the tensorflow backend...
        \item What is the role of the parameter $M$ in alg. (\ref{alg:loss_computation})? Could one safely set $M=1$ and still hope for convergence, a bit like in reinforcement learning? Setting $M=1$ is of course a very rough estimate of the expected value, but since it is embedded in the training loop, maybe this estimate is actually enough?
        \item In strawberryfields the training procedure is managed by the tensorflow backend. Is it actually implementing the shift rule? Double check that.
        \item Maybe as a toy model of the toy model we can start by a single 1d harmonic oscillator
        \begin{equation}
            H = \frac{1}{2}\left(p^2+x^2\right) = a^\dagger a+\frac{1}{2}
        \end{equation}
        We can then test measuring separately both quadratures and compare with a single measurement of the photon number. The correct statevector is of course the Fock vacuum in that case. For me the problem is more related to the strawberryfields API than conceptual. Ideally I'd rather perform a single heterodyne measurement on each channel, the cost function is then simply given by (\ref{eq:energy_coherent}).
        \item It seems that with the tf backend, one has to perform multiple shots manually, i.e. the 'shots' argument of the 'run' method is not implemented.
        \item I had problem related to the fact that the measurement process is non-differentiable. Then I checked at the paper of Xanadu on state preparation: in some sense they are cheating. They are computing the loss directly from the statevector, and they have access to the statevector because they are working on the simulator. On a real photonic device, one doesn't have access to the statevector directly, but only to the outcome of measurements. I propose that we bypass the issue by cheating the same way they did, unless some smart ORCA employee comes up with a nice solution haha. The only solution I could imagine for now is the following: getting inspiration from the 'reparameterization trick' using in the context of autoencoders. In that context one also has to backpropagate through a sampling operation from a probability distribution. In that case, the problem is solved because we know that the distribution is actually Gaussian, and therefore we can parameterize it in terms of its mean and variance, and differentiate with respect to those parameters. In our case however, the probability distribution defined by the ansatz state and the observable is of course not known generally, so it makes it difficult to use this trick...
    \end{itemize}
}

\textcolor{purple}{
    Things to be done:
    \begin{itemize}
        \item Generalization to 3d: just more harmonic oscillators basically
        \item Higher orders in the multipolar expansion
    \end{itemize}
}

\section{Introduction}


\section{Definition of the model}

    The Hamiltonian describing a system of $N$ QDOs in 3d is given by:
    \begin{equation}
    \label{eq:full_QDO_Hamiltonian}
        H=\sum_{i=1}^N\left[\frac{\bm{p} _i^2}{2m_i} + \frac{1}{2}m_i\omega_i^2\bm{x} _i^2\right] +\sum_{i<j}V_\text{Coul}\left(\bm{x} _i, \bm{x} _j\right)\,,
    \end{equation}
    with the Coulomb interaction receiving contributions from every pair of constituents (centers and point particles):
    \begin{equation}
    \label{eq:full_coulomb_potential}
        \frac{V_\text{Coul}\left(\bm{x} _i, \bm{x} _j\right)}{q_iq_j(4\pi\epsilon_0)^{-1}}=\frac{1}{r} - \frac{1}{|\bm{r}  + \bm{x} _i|} - \frac{1}{|\bm{r}  - \bm{x} _j|} + \frac{1}{|\bm{r}  - \bm{x} _j + \bm{x} _i|}
    \end{equation}
    In the multipolar expansion, this can be expressed as a power series in the inverse distance separating the two centers:
    \begin{equation}
        V_\text{Coul}\left(\bm{x} _i, \bm{x} _j\right)= \sum_{n\geq 0} V_n\left(\bm{x} _i, \bm{x} _j\right)\,,
    \end{equation}
    with the following scaling behavior in terms of the distance between the centers:
    \begin{equation}
        V_n\left(\bm{x} _i, \bm{x} _j\right)\propto r_{ij}^{-n-3}\,.
    \end{equation}

        \subsection{One-dimensional case}

        We consider the one dimensional system in which the electrons are constrained to move either in the direction parallel to the axis separating the two nuclei, or perpendicular to the latter.
        \begin{equation}
            V_0(x_i, x_j) = \frac{q_iq_j}{4\pi\epsilon_0}\frac{x_ix_j}{r_{ij}^3}\times
            \begin{cases}
                -2, & \text{parallel case} \\
                1, & \text{perpendicular case}
            \end{cases}
        \end{equation}
        We define
        \begin{equation}
            \gamma_{ij} := \frac{q_iq_j}{4\pi\epsilon_0r_{ij}^3}\times
            \begin{cases}
                -2, & \text{parallel case} \\
                1, & \text{perpendicular case}
            \end{cases}
        \end{equation}

        We therefore reach the following one dimensional model for $N$ QDOs in the dipolar approximation:
        \begin{equation}
            \begin{split}
                &H = \sum_{i=1}^N\left(\frac{p_i^2}{2m_i}+\frac{1}{2}m_i\omega_i^2 x_i^2\right) + \sum_{i<j}\gamma_{ij}x_ix_j\\
                &= \sum_{i=1}^N\hbar\omega_i\left(a_i^\dagger a_i+\frac{1}{2}\right) + \sum_{i<j}\gamma_{ij}x_ix_j\\
                &= \sum_{i=1}^N\hbar\omega_i\left(a_i^\dagger a_i+\frac{1}{2}\right) \\
                &\ \ +\frac{\hbar}{2}\sum_{i<j}\frac{\gamma_{ij}}{\sqrt{m_im_j\omega_i\omega_j}}\left(a_i+a_i^\dagger\right)\left(a_j+a_j^\dagger\right)
            \end{split}
        \end{equation}
        with the annihilation and creation operators:
        \begin{equation}
            \begin{split}
                a_i &= \sqrt{\frac{m_i\omega_i}{2\hbar}}\,x_i+\frac{i}{\sqrt{2\hbar m_i\omega_i}}\,p_i\,,\\
                a_i^\dagger &= \sqrt{\frac{m_i\omega_i}{2\hbar}}\,x_i-\frac{i}{\sqrt{2\hbar m_i\omega_i}}\,p_i\,,
            \end{split}
        \end{equation}
        and where the from the second line we have symmetrized the Hamiltonian and used the canonical commutation relation.
        Just in case, let me write down the next terms in the multipolar expansion:
        \begin{equation}
            V_1(x_i, x_j) = \frac{q_iq_j}{4\pi\epsilon_0}\frac{x_ix_j(x_i-x_j)}{r_{ij}^4}\times
            \begin{cases}
                3, & \text{parallel case} \\
                0, & \text{perpendicular case}
            \end{cases}
        \end{equation}
        \begin{equation}
            \begin{split}
                V_2(x_i, x_j) = &\frac{q_iq_j}{4\pi\epsilon_0}\frac{x_ix_j(2x_i^2-3x_ix_j+2x_j^2)}{r_{ij}^5}\\
                &\times
                \begin{cases}
                    -2, & \text{parallel case} \\
                -\frac{3}{4}, & \text{perpendicular case}
                \end{cases}
            \end{split}
        \end{equation}
        even though we will probably focus on the dipolar approximation.

        For simplicity in the following, we will perform the following simplifications:
        \begin{itemize}
            \item All the masses are equal to a common value $m$, that we set equal to 1.
            \item All the frequences are equal to a common value $\omega$, that we set equal to 1.
            \item All the charges are equal to a common value $q$, that we set equal to 1.
            \item We also set $\hbar=1$ and $\tfrac{1}{4\pi\epsilon_0}=1$.
        \end{itemize}
        The model therefore reads:
        \begin{equation}
        \label{eq:hamiltonian_N_qdos}
            H = \sum_{i=1}^N\left(a_i^\dagger a_i+\frac{1}{2}\right) + \frac{1}{2}\sum_{i<j}\gamma_{ij}\left(a_i+a_i^\dagger\right)\left(a_j+a_j^\dagger\right)\,.
        \end{equation}
        In the case of two QDOs we have:
        \begin{equation}
            H = a_1^\dagger a_1 + a_2^\dagger a_2 + \frac{\gamma}{2}\left(a_1+a_1^\dagger\right)\left(a_2+a_2^\dagger\right) + 1\,,
        \end{equation}
        with
        \begin{equation}
            \gamma := \frac{1}{r^3}\times
            \begin{cases}
                -2, & \text{parallel case} \\
                1, & \text{perpendicular case}
            \end{cases}
        \end{equation}
        where $r$ is the distance between the two nuclei.



    \subsection{Three-dimensional case}

        \subsubsection{Multipolar expansion}

            The dipole-dipole potential in 3d reads:
            \begin{equation}
                V_0(\bm{x} _i, \bm{x} _j) = \frac{\bm{x} _i\cdot \bm{x} _j - 3 (\bm{x} _i\cdot \bm{n} _{ij})(\bm{x} _j\cdot \bm{n} _{ij})}{r_{ij}^3}=\bm{x} _i \mathbb T_{ij} \bm{x} _j\,,
            \end{equation}
            where $r_{ij}\bm{n} _{ij}$ is the vector connecting nuclei $j$ to nuclei $i$, and we defined the tensor
            \begin{equation}
                \mathbb T_{ij} = \frac{\mathbb I_3 - \bm{n} _{ij}\otimes\bm{n} _{ij}}{r_{ij}^3}\,.
            \end{equation}
            In the case of 2 QDOs sitting along the $z$-axis and separated by a distance $r$:
            \begin{equation}
                V_0(\bm{x} _1, \bm{x} _2) = \frac{x_1x_2 + y_1y_2 - z_1z_2}{r^3}\,.
            \end{equation}
            We therefore need free channels per QDO, so a total of 6 channels.
        \subsection{Full Coulomb potential}

            We still consider the case of 2 QDOs, but this time we treat the full Coulomb potential (\ref{eq:full_coulomb_potential}). We take the two nuclei to be aligned along the z-axis and separated by a distance $r$. The potential can be written as
            \begin{equation}
            \begin{split}
                &V_\text{Coul}(\bm{x} _1, \bm{x} _2) = \frac{1}{r} - \frac{1}{\left(r^2 + x_1^2+y_1^2+z_1^2+2rz_1\right)^{\frac{1}{2}}} \\
                &- \frac{1}{\left(r^2 + x_2^2+y_2^2+z_2^2-2rz_2\right)^{\frac{1}{2}}} \\
                &+\frac{1}{\left(r^2 + (x_2-x_1)^2+(y_2-y_1)^2+(z_2-z_1)^2-2r(z_2-z_1)\right)^{\frac{1}{2}}}
            \end{split}
            \end{equation}

\section{Photonic circuit}

    The circuit implements a unitary $U(\theta)$ acting on an input reference state (the Fock vacuum for instance) that we simply take to be the vacuum state $|0\rangle$. The state prepared by the circuit is therefore given by
    \begin{equation}
        |\psi(\theta)\rangle = U(\theta)|0\rangle\,.
    \end{equation}

    Since we are working in the dipolar approximation, we expect that using a Gaussian state would be enough. The circuit is therefore composed of at most quadratic optical components (squeezing operations for our ansatz). A non-Gaussian operation can optionally be added in the end of each layer in the ansatz circuit.

\section{Variational algorithm}

    We define the following loss function:
    \begin{equation}
        \mathcal C(\theta) := \langle\psi(\theta)|H|\psi(\theta)\rangle
    \end{equation}
    with the Hamiltonian defined in eq. (\ref{eq:hamiltonian_N_qdos}).
    In order to compute this loss, one therefore has to measure both the photon number operator on each channel, as well as the position quadrature operator on each channel.
    \newpage

    \begin{algorithm}
        \caption{Computation of the energy using photon numbers and quadratures}\label{alg:energy_computation}
            \textbf{Parameters:} reference statevector $|0\rangle$, circuit $U$

            \KwResult{Value of the energy $E$}\

            Prepare statevector $|\psi\rangle = U|0\rangle$\;
            Measure the position quadratures $x_i$\;
            Prepare statevector $|\psi\rangle = U|0\rangle$\;
            Measure the photon numbers $n_i$\;
            Compute the energy $E$ with eq. (\ref{eq:hamiltonian_N_qdos})\;
            \textbf{return} $E$.
    \end{algorithm}

    \begin{algorithm}
        \caption{Computation of the energy using coherent state basis}\label{alg:energy_computation_coherent_basis}
            \textbf{Parameters:} reference statevector $|0\rangle$, circuit $U$

            \KwResult{Value of the energy $E$}\

            Prepare statevector $|\psi\rangle = U|0\rangle$\;
            Perform heterodyne measurement on each channel to get $\alpha_i$\;
            Compute the energy $E$ with eq. (\ref{eq:hamiltonian_N_qdos})\;
            \textbf{return} $E$.
    \end{algorithm}

    \begin{algorithm}
        \caption{Computation of the energy using quadratures}
        \label{alg:energy_computation_quadratures}
            \textbf{Parameters:} reference statevector $|0\rangle$, circuit $U$

            \KwResult{Value of the energy $E$}\

            Prepare statevector $|\psi\rangle = U|0\rangle$\;
            Perform homodyne measurement on each channel to get the position quadratures $x_i$\;
            Prepare statevector $|\psi\rangle = U|0\rangle$\;
            Perform homodyne measurement on each channel to get the momentum quadratures $p_i$\;
            Compute the energy $E$ with eq. (\ref{eq:hamiltonian_N_qdos})\;
            \textbf{return} $E$.
    \end{algorithm}

    \begin{algorithm}
        \caption{Computation of the loss}\label{alg:loss_computation}
            \textbf{Parameters:} $M\in\mathbb N$

            \KwResult{Value of the loss $\mathcal C$}\

            Initialize $\mathcal C \gets 0$\;
            \For{$j=1$ to $M$}{
                Compute the energy $E$ with alg. (\ref{alg:energy_computation}), (\ref{alg:energy_computation_coherent_basis}) or (\ref{alg:energy_computation_quadratures})\;
                Update the loss $\mathcal C \gets \mathcal C + E$\;
                \textbf{end for}
                }
                $\mathcal C \gets \mathcal C / M$\;
            \textbf{return} $\mathcal C$.
    \end{algorithm}

    \begin{algorithm}
        \caption{Training of the parameterized photonic circuit}\label{alg:training}
        \textbf{Parameters:} $N_\text{steps}\in\mathbb N$, initial parameters $\theta_0\in\mathbb R^K$, learning rate $\eta\in\mathbb R_+$

        \KwResult{Optimized hyperparameters $\theta\in\mathbb R^K$}\

        Initialize hyperparameters $\theta \gets \theta_0$\;
        \For{$i=1$ to $N_\text{steps}$}{
        Compute the loss $\mathcal C$ with alg. (\ref{alg:loss_computation})\;
        Compute the gradient $\nabla_\theta\mathcal C$ with shift rule and alg. (\ref{alg:loss_computation})\;
            Update the parameters $\theta \gets \theta - \eta\nabla_\theta\mathcal C$\;
        \textbf{end for}
        }
        \textbf{return} $\theta$.
    \end{algorithm}

    After measuring the amplitude $\alpha_i$ on each channel with heterodyne detections, the measured energy reads
    \begin{equation}
    \label{eq:energy_coherent}
        E = \sum_{i=1}^N\left(|\alpha_i|^2+\frac{1}{2}\right) + 2\sum_{i<j}\gamma_{ij}\text{Re}(\alpha_i)\text{Re}(\alpha_j)
    \end{equation}
    The expected value of the energy in state $|\psi\rangle$ is obtained by averaging the result of $M\in\mathbb N$ such measurements:
    \begin{equation}
        \langle\psi|H|\psi\rangle = \frac{1}{M}\sum_{j=1}^M E_j + \mathcal O\left(\frac{1}{\sqrt M}\right)
    \end{equation}
    A very rough estimate would consist in setting $M=1$.

\section{Results}
\section{Conclusion}

\begin{acknowledgments}

\end{acknowledgments}

\section*{Code Availability}

The reader will find an open source python code accompanying this paper following this \href{https://github.com/MatthieuSarkis/qdo}{github repository}.

\appendix

\nocite{*}
\bibliographystyle{IEEEtran}
\bibliography{bibliography}

\end{document}